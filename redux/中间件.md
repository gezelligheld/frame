redux中间件提供的是action触发后，到达reducer之前的扩展，即将view -> action -> reducer -> store扩展为view -> action -> middleware -> reducer -> store，在这个环节下可以进行副作用操作，如异步请求、打印日志等

![middleware的作用](https://user-gold-cdn.xitu.io/2018/4/19/162dcb142c194bfb?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

使用如下，以react-thunk为例

```js
import {createStore, compose, applyMiddleware} from 'redux';
import thunk from 'redux-thunk';

const store = createStore(rootReducer, compose(applyMiddleware(thunk)));
```

#### 原理

##### applyMiddleware

本质上是对dispatch做了改造，实现如下

```js
function applyMiddleware(...middlewares) {
    return createStore => {
        return reducer => {
            const store = createStore(reducer);
            let dispatch = store.dispatch;
            // 每个middleware接受这两个参数
            const middlewareParam = {
                getState: store.getState,
                dispatch: action => dispatch(action)
            };
            // 可以传入多个middleware，依次执行，且无需关心前后的middleware
            // middleware的形式({ getState, dispatch }) => next => action
            const chain = middlewares.map(middleware => middleware(middlewareParam));
            dispatch = compose(...chain)(store.dispatch);
            // 覆盖掉原来的dispatch
            return {...store, dispatch};
        };
    };
}
```

##### compose